<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チャンネル - 仙人YouTubeビュアー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e1e2f">
  <link rel="icon" href="icon-192.png">
  <style>
    body { font-family: sans-serif; background: #1e1e2f; color: #fff; margin: 0; }
    header { background: #27293d; padding: 1em; text-align: center; font-size: 1.2em; }
    main { padding: 1em; }
    .channel-info { display: flex; align-items: center; gap: 1em; margin-bottom: 1em; }
    .channel-info img { width: 64px; height: 64px; border-radius: 50%; }
    .channel-meta { display: flex; flex-direction: column; }
    .channel-meta .title { font-size: 1.2em; font-weight: bold; }
    .channel-meta .subs { color: #aaa; font-size: 0.9em; }

    .video-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1em; }
    .video-card { background: #2d2f44; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
    .video-card:hover { transform: scale(1.03); }
    .video-card img { width: 100%; display: block; }
    .video-card .info { padding: 0.5em; }
    .video-card .title { font-weight: bold; margin-bottom: 0.3em; }
  </style>
</head>
<body>
  <header>チャンネル</header>
  <main>
    <div id="channel-info" class="channel-info">読み込み中...</div>
    <h2>動画一覧</h2>
    <div id="video-list" class="video-list"></div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const channelId = params.get("id");
    const channelInfoEl = document.getElementById("channel-info");
    const videoListEl = document.getElementById("video-list");

    // ✅ チャンネル情報を取得
    async function loadChannel() {
      try {
        const res = await fetch(`/api/channel/${channelId}`);
        if (!res.ok) throw new Error("チャンネル情報取得失敗");
        const data = await res.json();

        channelInfoEl.innerHTML = `
          <img src="${data.avatar}" alt="">
          <div class="channel-meta">
            <div class="title">${data.title}</div>
            <div class="subs">${data.subs || '登録者数不明'}</div>
          </div>
        `;
      } catch (e) {
        channelInfoEl.innerHTML = "<p>チャンネル情報を取得できませんでした。</p>";
        console.error(e);
      }
    }

    // ✅ チャンネル動画を取得
    async function loadVideos() {
      try {
        const res = await fetch(`/api/channel/${channelId}/videos`);
        if (!res.ok) throw new Error("動画一覧取得失敗");
        const data = await res.json();

        videoListEl.innerHTML = '';
        if (!data.videos || data.videos.length === 0) {
          videoListEl.innerHTML = "<p>動画がありません。</p>";
          return;
        }

        data.videos.forEach(video => {
          const card = document.createElement('div');
          card.className = 'video-card';
          card.innerHTML = `
            <img src="${video.thumbnail}" alt="">
            <div class="info">
              <div class="title">${video.title}</div>
            </div>
          `;
          card.onclick = () => {
            window.location.href = `watch.html?id=${video.videoId}`;
          };
          videoListEl.appendChild(card);
        });
      } catch (e) {
        videoListEl.innerHTML = "<p>動画一覧の取得に失敗しました。</p>";
        console.error(e);
      }
    }

    if (channelId) {
      loadChannel();
      loadVideos();
    } else {
      channelInfoEl.innerHTML = "<p>チャンネルIDが指定されていません。</p>";
    }
  </script>
</body>
</html>
